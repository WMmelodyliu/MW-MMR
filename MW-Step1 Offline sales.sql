CREATE OR REPLACE TABLE wmt-mint-mmr-mw-prod.mw_numerator_dev.offline_sales_FY26Feb_breakout AS --update(R)
SELECT FIN_RPT_CD,FIN_RPT_DESC,UPC_NBR,item_nbr, MDS_FAM_ID,ITEM_DESC_1,BASE_DIV_NBR,GEO_REGION_CD,DEPT_NBR,DEPT_DESC,MDSE_CATG_NBR,
MDSE_CATG_DESC, MDSE_SUBCATG_NBR,MDSE_SUBCATG_DESC,FINELINE_NBR,FINELINE_DESC,ACCTG_DEPT_NBR,acctg_dept_nm as ACCTG_DEPT_DESC,DEPT_SUBCATG_NBR,DEPT_SUBCATG_DESC, DEPT_CATG_NBR,DEPT_CATG_DESC,DEPT_CATG_GRP_NBR,DEPT_CATG_GRP_DESC,MDSE_SUBGROUP_NBR,MDSE_SUBGROUP_DESC,MDSE_SEG_NBR,
MDSE_SEG_DESC,VENDOR_NBR,VENDOR_NM,ITEM_DESC_2,COLOR_DESC,SIZE_DESC,SHOP_DESC,SIGNING_DESC,UPC_DESC,PLU_NBR,CONS_ITEM_DESC,
PROD_DESC,ITEM_STATUS_CD,ITEM_STATUS_DESC,WM_FULL_YR_NBR,WM_MTH_NBR,WM_WK_NBR,VISIT_DATE,VISIT_TYPE,VISIT_SUBTYPE_CODE, 
store_breakout,
brand_breakout,
SUM(SALES) AS total_sales,SUM(unit_qty) AS total_units,COUNT(*) AS total_visits
from (
select item.*,str_sales.STORE_NBR,str_sales.FIN_RPT_CD,str_sales.FIN_RPT_DESC,str_sales.SCAN_ID,str_sales.ACCTG_DEPT_NBR,str_sales.acctg_dept_nm,
str_sales.visit_date,str_sales.visit_type,str_sales.visit_subtype_code,str_sales.WM_FULL_YR_NBR,str_sales.WM_MTH_NBR,str_sales.WM_WK_NBR,
str_sales.sales,str_sales.unit_qty, 
store_breakout
from 
(SELECT distinct UPC_NBR,ITEM_NBR,MDS_FAM_ID,ITEM_DESC_1,BASE_DIV_NBR,GEO_REGION_CD,DEPT_NBR,DEPT_DESC,MDSE_CATG_NBR,MDSE_CATG_DESC ,
MDSE_SUBCATG_NBR,MDSE_SUBCATG_DESC,FINELINE_NBR,FINELINE_DESC,
--ACCTG_DEPT_NBR,
--ACCTG_DEPT_DESC,
DEPT_SUBCATG_NBR,
DEPT_SUBCATG_DESC ,DEPT_CATG_NBR,DEPT_CATG_DESC,DEPT_CATG_GRP_NBR,DEPT_CATG_GRP_DESC,MDSE_SUBGROUP_NBR,MDSE_SUBGROUP_DESC,
MDSE_SEG_NBR ,MDSE_SEG_DESC,VENDOR_NBR,VENDOR_NM,ITEM_DESC_2,COLOR_DESC,SIZE_DESC,SHOP_DESC,SIGNING_DESC,
UPC_DESC,PLU_NBR,CONS_ITEM_DESC ,PROD_DESC,ITEM_STATUS_CD,ITEM_STATUS_DESC,
-- adding brand type
-- from PB Store Only.txt
CASE WHEN BRAND_ID IN (437122,540251,209702,272035,441247,391786,499475,537981,541119,385054,461574,540250,541379,541543,552747,404125,537982,498801,540268,552735,475399,541252,453444,446143,540292,280672,416375,416376,416377,430158,416378,400098,423131,416379,416380,416381,416382,416383,416384,416385,416386,416387,482152,279904,540297,460104,541120,460105,450482,553992,496841,440544,540293,134167,499127,506658,441993,209719,296071,509558,532447,545015,552708,401887,482153,541402,482151,540270,387459,451855,553778,372871,323546,206398,480596,480597,480598,480599,476966,206397,440543,451592,435003,278082,427268,283525,476967,554027,315458,457998,552566,550582,451895,458441,440047,209695,540269,206399,480603,550569,388885,452261,451904,541542,476965,552709,550580,541253,543793,439429,537790,540888,546855,272057,310995,449266,512777,481455,482064,325838,443842,401886,209722,542912,119436,542914,240609,97261,241747,247297,213133,410623,449262,3333,534060,542913,209697,455152,436181,484126,176751,510492,436761,206395,451214,455154,381353,211292,428133,234503,381697,428139,453521,435993,482215,414041,542579,409476,415789,486189,365085,434017,299134,198525,241742,561673,561674,448443,556369,388693,571782,561046,561047,561042,561040,561041,561043,450492,561048,561049,561045,561044,561438,450492,572858,572859) OR (brand_id = 578905 AND vendor_nbr = 46095) THEN "PB" ELSE "OTHER" END AS brand_breakout
FROM wmt-edw-prod.WW_CORE_DIM_DL_VM.DL_ITEM_DIM -- item
WHERE base_div_nbr = 1
AND GEO_REGION_CD='US'
AND OP_CMPNY_CD = 'WMT-US')item
inner join
(select store.STORE_NBR,acctg_dept_nbr,acctg_dept_nm,upc_nbr,FIN_RPT_CD,FIN_RPT_DESC,SCAN_ID,
visit_date,visit_type,visit_subtype_code, store_breakout,
WM_FULL_YR_NBR,WM_MTH_NBR,WM_WK_NBR,
SUM(sales) AS sales,SUM(unit_qty) AS unit_qty
from (SELECT distinct STORE_NBR,FIN_RPT_CD,FIN_RPT_DESC, 
-- adding store type
CASE WHEN store_type_cd = "U" and banner_cd = "A1" THEN "SC" -- supercenter
WHEN store_type_cd = "U" and banner_cd IN ("B4", "S3") THEN "NM" -- neighborhood market
ELSE "OTHER" END AS store_breakout 
FROM wmt-edw-prod.WW_CORE_DIM_DL_VM.DL_STORE_CLUB_DIM -- store
WHERE CNTRY_CD = "US"
AND BASE_DIV_NBR = 1 
AND STATE_PROV_CD NOT IN('PR')
)store
INNER JOIN
(select store_nbr,acctg_dept_nbr,acctg_dept_nm,upc_nbr,omni_item_nbr as scan_id,event_dt as visit_date,
WM_FULL_YR_NBR,WM_MTH_NBR,WM_WK_NBR,
CHANNEL_TYPE_CD as VISIT_TYPE,CHANNEL_SUBTYPE_CD as VISIT_SUBTYPE_CODE,
sum(sales_amt) as sales,sum(SALES_UNIT_QTY) as unit_qty
from wmt-edw-prod.US_FIN_SALES_DL_RPT_VM.OMNI_ITEM_SALES_DLY_D -- sales
where 
event_dt between '2024-10-26' and '2025-02-28' --update(R)
and acctg_dept_nbr not in (-999,15,27,28,30,35,36,37,38,39,57,58,60,61,62,63,64,65,66,68,69,70,75,76,83,84,85,86,88,89,99) --exclude
AND STATE_CD_FULFMT <> 'PR' --exclude
and CHANNEL_TYPE_NM in ('STORE SALE','LAYAWAY')
group by 1,2,3,4,5,6,7,8,9,10,11
)sales_tbl
on store.store_nbr=sales_tbl.store_nbr
group by store.STORE_NBR,acctg_dept_nbr,acctg_dept_nm,upc_nbr,FIN_RPT_CD,FIN_RPT_DESC,SCAN_ID,
visit_date,visit_type,visit_subtype_code,WM_FULL_YR_NBR,WM_MTH_NBR,WM_WK_NBR, 
store_breakout
)str_sales
on item.mds_fam_id=str_sales.scan_id
)final_tbl
group by FIN_RPT_CD,FIN_RPT_DESC,UPC_NBR,item_nbr, MDS_FAM_ID,ITEM_DESC_1,BASE_DIV_NBR,GEO_REGION_CD,DEPT_NBR,DEPT_DESC,MDSE_CATG_NBR,
MDSE_CATG_DESC, MDSE_SUBCATG_NBR,MDSE_SUBCATG_DESC,FINELINE_NBR,FINELINE_DESC,ACCTG_DEPT_NBR,ACCTG_DEPT_DESC,DEPT_SUBCATG_NBR,DEPT_SUBCATG_DESC,
DEPT_CATG_NBR,DEPT_CATG_DESC,DEPT_CATG_GRP_NBR,DEPT_CATG_GRP_DESC,MDSE_SUBGROUP_NBR,MDSE_SUBGROUP_DESC,MDSE_SEG_NBR,
MDSE_SEG_DESC,VENDOR_NBR,VENDOR_NM,ITEM_DESC_2,COLOR_DESC,SIZE_DESC,SHOP_DESC,SIGNING_DESC,UPC_DESC,PLU_NBR,CONS_ITEM_DESC,
PROD_DESC,ITEM_STATUS_CD,ITEM_STATUS_DESC,WM_FULL_YR_NBR,WM_MTH_NBR,WM_WK_NBR,VISIT_DATE,VISIT_TYPE,VISIT_SUBTYPE_CODE,
store_breakout,brand_breakout
